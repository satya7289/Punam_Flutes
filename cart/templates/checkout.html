{% extends 'store/base.html' %}
{% load staticfiles %}
{% block content %}

<!-- BREADCRUMB -->
<nav class="py-5">
  <div class="container">
    <div class="row">
      <div class="col-12">

        <!-- Breadcrumb -->
        <ol class="breadcrumb mb-0 font-size-xs text-gray-400">
          <li class="breadcrumb-item">
            <a class="text-gray-400" href="index.html">Home</a>
          </li>
          <li class="breadcrumb-item">
            <a class="text-gray-400" href="shopping-cart.html">Shopping Cart</a>
          </li>
          <li class="breadcrumb-item active">
            Checkout
          </li>
        </ol>

      </div>
    </div>
  </div>
</nav>
  
<!-- CONTENT -->
<section class="pt-7 pb-12">
  <div class="container">
    <div class="row">
      <div class="col-12 text-center">

        <!-- Heading -->
        <h3 class="mb-4">Checkout</h3>
        {% if not request.user.is_authenticated %}
          <!-- Subheading -->
          <p class="mb-10">
            Already have an account? <a class="font-weight-bold text-reset" href="{% url 'customer_login' %}">Click here to login</a>
          </p>
        {% endif %}

      </div>
    </div>
    <div class="row">
      <div class="col-12 col-md-7">

        <!-- Form -->
        <form id='checkout-form' action="{% url 'checkout' %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <!-- Heading -->
          <h6 class="mb-7">Billing Details</h6>

          <!-- Billing details -->
          <div class="row mb-9">
            <div class="col-12 col-md-6">

              <!-- First Name -->
              <div class="form-group">
                <label for="checkoutBillingFirstName">First Name *</label>
                {% if profile %}
                    <input class="form-control form-control-sm" id="firstName" type="text" placeholder="First Name" required name="first_name" value="{{ profile.first_name}}">
                {% else %}
                    <input class="form-control form-control-sm" id="firstName" type="text" placeholder="First Name" required name="first_name">
                {% endif %}
              </div>

              </div>
              <div class="col-12 col-md-6">

                <!-- Last Name -->
                <div class="form-group">
                  <label for="lastName">Last Name *</label>
                  {% if profile %}
                      <input class="form-control form-control-sm" id="lastName" type="text" placeholder="Last Name" required name="last_name" value="{{ profile.last_name}}">
                  {% else %}
                      <input class="form-control form-control-sm" id="lastName" type="text" placeholder="Last Name" required name="last_name">
                  {% endif %}
                </div>

              </div>
              <div class="col-12">

                <!-- Email -->
                <div class="form-group">
                  <label for="checkoutBillingEmail">Email *</label>
                  <p id="checkoutBillingEmail">{{ email }}</p>  
                </div>

              </div>
              <div class="col-12">

                <!-- Mobile Phone -->
                <div class="form-group mb-0">
                  <label for="checkoutBillingPhone">Mobile Phone *</label>
                  {% if profile %}
                      <input class="form-control form-control-sm" id="checkoutBillingPhone" type="tel" placeholder="Mobile Phone" required name="contact_number" value="{{ profile.contact_number}}">
                  {% else %}
                      <input class="form-control form-control-sm" id="checkoutBillingPhone" type="tel" placeholder="Mobile Phone" required name="contact_number">
                  {% endif %}
                </div>

              </div>
          </div>

          <!-- Heading -->
          <h6 class="mb-7">Shipping Address</h6>
          <!-- <div class="col-12">
            {% for add in user_address %}
              {% if forloop.counter is 1%}
                <div class="radio"><label><input type="radio" name="address" id='address' checked data-id="{{ add.id }}">{{ add }}</label></div>
              {% else %}
                <div class="radio"><label><input type="radio" name="address" id='address' data-id="{{ add.id }}">{ add }</label></div>
              {% endif %}
            {% endfor %}
          </div> -->

          <div class="col-12">
            {% if user_address %}
              <select class="form-control" name="address">
                {% for add in user_address %}
                  {% if forloop.counter is 1%}
                    <option selected value="{{ add.id }}"> {{ add }}</option>
                  {% else %}
                    <option value="{{ add.id }}"> {{ add }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            {% else %}
              <a href="{% url 'customer_profile' %}">Add address</a>
            {% endif %}
          </div>
          <input type="hidden" name="total" value="0">
          <input type="hidden" name='cart_id' value="{{ cart.id }}">
        </form>

      </div>
      <div class="col-12 col-md-5 col-lg-4 offset-lg-1">

        <!-- Heading -->
        <h6 class="mb-7">Order Items ({{ orders.count }})</h6>

        <!-- Divider -->
        <hr class="my-7">

        <!-- List group -->
        <ul class="list-group list-group-lg list-group-flush-y list-group-flush-x mb-7">
          {% for order in orders %}
          <li class="list-group-item">
            <div class="row align-items-center">
              <div class="col-4">

                <!-- Image -->
                <a href="product.html">
                  <img src="{{ order.product.images.all.0.image.url }}" alt="..." class="img-fluid">
                </a>

              </div>
              <div class="col">

                <!-- Title -->
                <p class="mb-4 font-size-sm font-weight-bold">
                  <a class="text-body" href="product.html">{{ order.product.title }}</a> <br>
                  <span class="text-muted" id='order_price{{ forloop.counter }}' data-price="{{order.price}}" data-quantity="{{ order.quantity }}">{{ order.currency }} {{ order.price }}</span>
                </p>  
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>

        <!-- Card -->
        <div class="card mb-9 bg-light">
          <div class="card-body">
            <ul class="list-group list-group-sm list-group-flush-y list-group-flush-x">
              <li class="list-group-item d-flex">
                <span>Subtotal</span> <span class="ml-auto font-size-sm" id="subtotal">00.00</span>
              </li>
              <li class="list-group-item d-flex">
                <span>Tax</span> <span class="ml-auto font-size-sm" id="tax">00.00</span>
              </li>
              <li class="list-group-item d-flex">
                <span>Shipping</span> <span class="ml-auto font-size-sm" id="shipping">00.00</span>
              </li>
              <li class="list-group-item d-flex font-size-lg font-weight-bold">
                <span>Total</span> <span class="ml-auto" id="total">00.00</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- Disclaimer -->
        <p class="mb-7 font-size-xs text-gray-500">
          Your personal data will be used to process your order, support
          your experience throughout this website, and for other purposes
          described in our privacy policy.
        </p>

        <!-- Button -->
        <button class="btn btn-block btn-dark" id='process-btn'>
          Place Order
        </button>

      </div>
    </div>
  </div>
</section>
  
{% endblock %}

{% block script %}
<script>

$(document).ready(()=>{
  updateSubTotal();
});

$('#process-btn').click(()=>{
  $('#checkout-form').submit();
});

function updateSubTotal(){
  let currency = '{{ currency }}';

  let Subtotal = 0;
  let tax = 0;
  let Shipping = 0;
  $("[id*=order_price]").each(function(){
      Subtotal = Subtotal + parseFloat($(this).attr('data-price')*($(this).attr('data-quantity')));
      $(this).html(currency + Subtotal);
  });
  Subtotal = Subtotal.toFixed(2);
  $('#subtotal').html(currency + Subtotal);
  $('#total').html(currency + Subtotal);
  $('#tax').html(currency + tax);
  $('#shipping').html(currency + Shipping);
  $('[name=total]').val(Subtotal);
}

</script>
{% endblock %}